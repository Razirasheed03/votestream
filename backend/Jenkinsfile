pipeline {
  agent any

  environment {
    APP_NAME = "votestream-backend"
    APP_DIR  = "backend"
    NODE_OPTIONS = "--max-old-space-size=256"
    PM2_HOME = "/var/lib/jenkins/.pm2"
    PATH = "/usr/bin:/usr/local/bin:/bin"
  }

  options {
    timestamps()
    disableConcurrentBuilds()
  }

  stages {

    stage('Checkout') {
      steps {
        cleanWs()
        checkout scm
      }
    }

    stage('Install dependencies') {
      steps {
        dir(APP_DIR) {
          sh '''
            echo "Node version: $(node -v)"
            echo "NPM version: $(npm -v)"

            npm config set fund false
            npm config set audit false

            if [ ! -d node_modules ]; then
              npm install --no-optional --legacy-peer-deps
            else
              echo "node_modules exists, skipping npm install"
            fi
          '''
        }
      }
    }

    stage('Build') {
      steps {
        dir(APP_DIR) {
          sh '''
            echo "Building with limited memory"
            NODE_OPTIONS=--max-old-space-size=256 npm run build
          '''
        }
      }
    }

    stage('Deploy') {
      steps {
        dir(APP_DIR) {
          sh '''
            export PM2_HOME=/var/lib/jenkins/.pm2

            pm2 describe $APP_NAME >/dev/null 2>&1 \
              && pm2 restart $APP_NAME \
              || pm2 start dist/server.js --name $APP_NAME

            pm2 save
          '''
        }
      }
    }
  }

  post {
    success {
      echo "âœ… Deployment successful"
    }

    failure {
      echo "âŒ Pipeline failed"
    }

    always {
      echo "ğŸ§¹ Cleanup"
    }
  }
}
